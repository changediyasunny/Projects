<!DOCTYPE html>
<html>
<head>
    <title>Update Console</title>
<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-1.12.4.js')}}"></script>

<style type="text/css">

    #searchTerm{
        height: 70px;
        font-size: 18px;
        font-family: sans-serif;
    }
    .container{
        width: 70%;
        margin: 0 auto;
    }
    table
    {
        border-collapse: collapse;
        border-spacing: 0;
    }
    #addButton, #updateButton, #delButton, #commitButton{
        width: 150px;
        height:70px;
        background: #3b5998;
        color: white;
    }
    tbody tr:nth-child(even){
      background:#ECF0F1;
    }
    tbody{
      font:1.2em normal Arial,sans-serif;
      color:#34495E;
      overflow-y: auto;
    }
    .RedLine{
      border:2px solid #1DBC9C;
    }
    .RedLine thead{
      background:#9B59B6;
    }
    th{
      text-align:center;
      padding:5px 0;
    }

    thead {
        color: white;
        display: table-header-group;
    }

    form{
        display: inline;
    }

</style>

    <script type="text/javascript">

        function myCommit()
        {
            flag = 0;
            //prompt ; returns NULL on "cancel" click...
            var myMesg = prompt("Enter commit message", "");
            //alert(myMesg);
            
            if(myMesg === null)
            {
            	return false;
            }

            if(myMesg.length)
            {
                //alert("hahahha");
                var res = myMesg.split("-");
                if(myMesg.length==7 && myMesg.indexOf('-') > -1 && myMesg.startsWith("B"))
                {
                    //document.getElementById("demo").innerHTML = res[1];
                    var nums = /^\d+$/.test(res[1]);
                    if(nums)
                    {
                        //document.getElementById("demo1").innerHTML = nums;
                        alert("message submitted...");
                        flag = 1;
                        var myJsonObj = JSON.stringify(myMesg);
                        console.log(myJsonObj);
                        $.ajax({
                            type: 'POST',
                            // Provide correct Content-Type, so that Flask will know how to process it.
                            contentType: 'application/json;charset=UTF-8',
                            // Encode your data as JSON.
                            data: JSON.stringify(myMesg, null, '\t'),
                            // This is the type of data you're expecting back from the server.
                            url: '/commit',
                            success: function (e)
                            {
                                console.log(e);
                            }
                        });
                    }
                }
            }
            if(flag==0)
            {
                alert("Invalid message: Usage< B-XXXXX (X:-integer-ID)>");
                return false;
            }
        }

        function myUpdate()
        {
            var myDict = [];

            var myTable = document.getElementById('dataTable');
            var numRows = myTable.rows.length;

            for (var i = 1; i < numRows; i++)
            {
                var cols = myTable.rows.item(i).cells;
                var numCols = cols.length;
                //3-columns, and select only data columns... Not checkBoxes
                for(var j=1; j< numCols; j++)
                {
                    var my_tag = cols.item(j).innerHTML.replace("<br>", '');
                    var my_val = cols.item(j+1).innerHTML.replace("<br>", '');
                    var final_str = my_tag+"-->>"+my_val;
                    myDict.push(final_str)
                    j = 3;
                }
            }
            var myJsonObj = JSON.stringify(myDict);
            console.log(myJsonObj);
            $.ajax({
                type: 'POST',
                // Provide correct Content-Type, so that Flask will know how to process it.
                contentType: 'application/json;charset=UTF-8',
                // Encode your data as JSON.
                data: JSON.stringify(myDict, null, '\t'),
                // This is the type of data you're expecting back from the server.
                url: '/update',
                success: function (e) {
                    console.log(e);
                }
            });
        }

        function doSearch() {
    		var searchText = document.getElementById('searchTerm').value;
    		var targetTable = document.getElementById('dataTable');
    		var targetTableColCount;

    		//Loop through table rows
    		for (var rowIndex = 0; rowIndex < targetTable.rows.length; rowIndex++)
    		{
    			var rowData = '';

    			//Get column count from header row
    			if (rowIndex == 0)
    			{
    				targetTableColCount = targetTable.rows.item(rowIndex).cells.length;
    				continue; //do not execute further code for header row.
    			}
    			//Process data rows. (rowIndex >= 1)
    			for (var colIndex = 0; colIndex < targetTableColCount; colIndex++)
                {
    				var cellText = '';
    				if (navigator.appName == 'Microsoft Internet Explorer')
    					cellText = targetTable.rows.item(rowIndex).cells.item(colIndex).innerText;
    				else
    					cellText = targetTable.rows.item(rowIndex).cells.item(colIndex).textContent;

    				rowData += cellText;
    			}

    			// Make search case insensitive.
    			rowData = rowData.toLowerCase();
    			searchText = searchText.toLowerCase();

    			if (rowData.indexOf(searchText) == -1)
    				targetTable.rows.item(rowIndex).style.display = 'none';
    			else
    				targetTable.rows.item(rowIndex).style.display = 'table-row';
    		}
    	}

        function myAdd()
        {
            var myTable = document.getElementById("dataTable");
            var new_row = myTable.insertRow(1);
            var x = new_row.insertCell(0);
            x.innerHTML = "<input type='checkbox' name='chk'/>"
            x.setAttribute("type","checkbox");
            var cell1 = new_row.insertCell(1);
            var cell2 = new_row.insertCell(2);
            cell1.innerHTML = "enter here";
            cell2.innerHTML = "enter here";
            cell1.setAttribute("contenteditable","true");
            cell2.setAttribute("contenteditable","true");
        }

        function myDel()
        {

            var table = document.getElementById("dataTable"); //.tBodies[0];
            var rowCount = table.rows.length;
            for(var i=1; i<rowCount; i++)
            {
                var row = table.rows[i];
                var chkbox = row.cells[0].getElementsByTagName('input')[0];
                if(null != chkbox && true == chkbox.checked)
                {
                    table.deleteRow(i);
                    rowCount--;
                    i--;
                }
            }
        }
    </script>
</head>
<body>

    <div class="container">
        <h2 style="color:brown; font-size:50px;">Welcome to Update Console </h2>
        <input type="text" id="searchTerm" class="search_box" onkeyup="doSearch()" placeholder="search here" />
        <br /><br />
        <button id="addButton" onclick="myAdd()">Add Entry</button>
        <button id="delButton" onclick="myDel()">Delete</button>
        <form action="/update">
            <button id="updateButton"  onclick="myUpdate()">Update</button>
        </form>
        <form action="/commit">
            <button id="commitButton"  onclick="return myCommit()">Commit</button>
        </form>
        <br><br>
        <div id="tableScroll">
            <!--<form action="/update"><button id="updateButton"  onclick="myEdit()">Update</button></form>-->
            <table id="dataTable" class="RedLine" border="1" width="100%" cellspacing="0" cellpadding="5">
                <thead>
                    <tr><th>#</th><th>Tag Name</th><th>Value</th></tr>
                </thead>
                <tbody>
                    {% for f in fields %}
                    <tr>
                        <td><input type="checkbox" name="{{f}}"/>&nbsp;</td>
                        <td contenteditable="true">{{f}}</td>
                        <td contenteditable="true">{{fields[f]}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</body>
</html>
